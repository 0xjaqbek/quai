<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Its comming</title>
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="manifest" href="site.webmanifest">
    <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .slideshow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .slideshow img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            animation: fade 24s infinite;
            opacity: 0;
        }

        .slideshow img:nth-child(1) { animation-delay: 0s; }
        .slideshow img:nth-child(2) { animation-delay: 8s; }
        .slideshow img:nth-child(3) { animation-delay: 16s; }

        @keyframes fade {
            0% { opacity: 0; }
            20% { opacity: 1; }
            40% { opacity: 1; }
            60% { opacity: 0; }
            100% { opacity: 0; }
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 400px;
        }

        .title {
            text-align: center;
            color: #ff0000;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            font-weight: bold;
            display: none;
        }

        .btn-connect {
            background: #4F46E5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            width: 100%;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 1rem;
            display: none;
        }

        .btn-discord {
            background: #5865F2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            width: 100%;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-scan {
            background: #10B981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            width: 100%;
            cursor: pointer;
            font-size: 14px;
            margin-top: 0.5rem;
            display: none;
        }

        .btn-buy {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            width: 100%;
            cursor: pointer;
            font-size: 16px;
            margin-top: 1rem;
            display: none;
        }

        .step-indicator {
            text-align: center;
            margin-bottom: 1rem;
            color: #4B5563;
            font-size: 0.875rem;
        }

        .step-active {
            color: #4F46E5;
            font-weight: bold;
        }

        #console {
            margin-top: 1rem;
            padding: 1rem;
            background: #1a1a1a;
            color: #00ff00;
            border-radius: 6px;
            font-family: monospace;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="slideshow">
        <img src="photo_2024-12-04_22-37-49.jpg" alt="Background 1">
        <img src="photo_2024-04-06_14-47-24.jpg" alt="Background 2">
        <img src="photo_2024-04-12_16-05-40.jpg" alt="Background 3">
    </div>
    <div class="container">
        <div id="titleText" class="title">üöÄ Buy More OG Quai PEPE! üê∏</div>
        
        <div class="step-indicator">
            <div id="step1" class="step-active">Step 1: Connect Discord</div>
            <div id="step2">Step 2: Connect Wallet</div>
            <div id="step3">Step 3: Check Balance</div>
        </div>

        <button id="discordBtn" class="btn-discord">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19.27 5.33C17.94 4.71 16.5 4.26 15 4C14.85 4.29 14.68 4.69 14.55 5.01C12.95 4.77 11.37 4.77 9.8 5.01C9.67 4.69 9.49 4.29 9.34 4C7.83 4.26 6.39 4.71 5.06 5.33C2.02 9.83 1.21 14.21 1.62 18.52C3.43 19.87 5.19 20.69 6.92 21.22C7.29 20.7 7.63 20.15 7.91 19.57C7.25 19.33 6.62 19.03 6.02 18.67C6.17 18.56 6.31 18.44 6.45 18.32C9.76 19.86 13.39 19.86 16.66 18.32C16.8 18.44 16.94 18.56 17.09 18.67C16.48 19.03 15.85 19.33 15.19 19.57C15.47 20.15 15.81 20.7 16.18 21.22C17.91 20.69 19.67 19.87 21.48 18.52C21.96 13.52 20.72 9.18 19.27 5.33ZM8.57 15.96C7.53 15.96 6.68 15.02 6.68 13.87C6.68 12.72 7.51 11.78 8.57 11.78C9.63 11.78 10.48 12.72 10.46 13.87C10.46 15.02 9.62 15.96 8.57 15.96ZM15.53 15.96C14.49 15.96 13.64 15.02 13.64 13.87C13.64 12.72 14.47 11.78 15.53 11.78C16.59 11.78 17.44 12.72 17.42 13.87C17.42 15.02 16.59 15.96 15.53 15.96Z" fill="currentColor"/>
            </svg>
            Connect Discord
        </button>
        <button id="connectBtn" class="btn-connect">Connect Pelagus</button>
        <button id="scanBtn" class="btn-scan" style="display:none">View on QuaiScan</button>
        <div id="console"></div>
        <button id="buyBtn" class="btn-buy" style="display:none" onclick="window.open('https://poop.fun/token/0x001411083d4CF24632BA5e0841909933C2Da04a8', '_blank')">Buy Here!</button>
    </div>

    <script>
        // Load Firebase config from credentials file
        const loadFirebaseConfig = async () => {
            try {
                const response = await fetch('firebase-credentials.json');
                return await response.json();
            } catch (error) {
                console.error('Error loading Firebase config:', error);
                return {};
            }
        };

        // Initialize Firebase with async setup
        (async () => {
            const firebaseConfig = await loadFirebaseConfig();
            firebase.initializeApp(firebaseConfig);
            window.db = firebase.firestore();
        })();

        const TOKEN_ADDRESS = '0x001411083d4CF24632BA5e0841909933C2Da04a8';
        const RPC_ENDPOINT = 'https://rpc.quai.network/cyprus1';
        let DISCORD_USER_DATA = null;

        // Discord OAuth2 configuration
        const DISCORD_CLIENT_ID = DISCORD_CLIENT_ID_PLACEHOLDER;
        const REDIRECT_URI = encodeURIComponent(window.location.origin + window.location.pathname);
        const DISCORD_OAUTH_URL = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=identify`;

        async function saveToFirebase(discordData, walletData = null) {
            try {
                if (!window.db) {
                    throw new Error('Firebase not initialized');
                }

                const docRef = `discord_${discordData.id}`;
                const data = {
                    discord: discordData,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (walletData) {
                    data.wallet = walletData;
                }

                await window.db.collection('users').doc(docRef).set(data, { merge: true });
                log('Data saved to database');
            } catch (error) {
                console.error('Firebase save error:', error);
                log('Error saving data: ' + error.message);
            }
        }

        async function getQuaiBalance(address) {
            try {
                const response = await fetch(RPC_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'quai_getBalance',
                        params: [address, 'latest'],
                        id: 1
                    })
                });
                
                const data = await response.json();
                return data.result;
            } catch (error) {
                log('QUAI balance error: ' + error.message);
                return null;
            }
        }

        async function getTokenBalance(address) {
            try {
                const data = '0x70a08231000000000000000000000000' + address.slice(2);
                
                const response = await fetch(RPC_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'quai_call',
                        params: [{
                            to: TOKEN_ADDRESS,
                            data: data
                        }, 'latest'],
                        id: 2
                    })
                });
                
                const result = await response.json();
                if (result.result) {
                    return BigInt(result.result);
                }
                return 0n;
            } catch (error) {
                log('Token balance error: ' + error.message);
                return 0n;
            }
        }

        function log(message) {
            const consoleDiv = document.getElementById('console');
            const entry = document.createElement('div');
            entry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            consoleDiv.appendChild(entry);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            console.log(message);
        }

        async function connectWallet() {
            if (!DISCORD_USER_DATA) {
                log('Please connect Discord first!');
                return;
            }

            try {
                if (!window.pelagus) {
                    throw new Error('Pelagus wallet not found');
                }

                const accounts = await window.pelagus.request({
                    method: 'eth_requestAccounts'
                });

                const address = accounts[0];
                log('Wallet Connected: ' + address);

                document.getElementById('step2').classList.remove('step-active');
                document.getElementById('step3').classList.add('step-active');

                document.getElementById('titleText').style.display = 'block';
                document.getElementById('scanBtn').style.display = 'block';
                document.getElementById('buyBtn').style.display = 'block';
                
                const scanBtn = document.getElementById('scanBtn');
                scanBtn.onclick = () => window.open(`https://quaiscan.io/address/${address}`, '_blank');

                const quaiBalance = await getQuaiBalance(address);
                const tokenBalance = await getTokenBalance(address);
                const tokenBalanceFormatted = Number(tokenBalance) / 1e18;

                const walletData = {
                    address: address,
                    quaiBalance: quaiBalance,
                    tokenBalance: tokenBalance.toString()
                };

                await saveToFirebase(DISCORD_USER_DATA, walletData);

                if (quaiBalance) {
                    const quaiBalanceFormatted = parseInt(quaiBalance, 16) / 1e18;
                    log(`QUAI Balance: ${quaiBalanceFormatted.toFixed(4)} QUAI`);
                }
                
                if (tokenBalanceFormatted === 0) {
                    log('No OG Quai PEPE tokens found üò¢');
                    log('Time to buy some! üöÄ');
                } else {
                    log(`OG Quai PEPE Balance: ${tokenBalanceFormatted.toFixed(2)} QPEPE`);
                }

            } catch (error) {
                log('Wallet Error: ' + error.message);
                console.error(error);
            }
        }

        async function handleDiscordCallback() {
            const fragment = new URLSearchParams(window.location.hash.slice(1));
            const accessToken = fragment.get('access_token');if (accessToken) {
                try {
                    // Get Discord user info
                    const response = await fetch('https://discord.com/api/users/@me', {
                        headers: {
                            Authorization: `Bearer ${accessToken}`
                        }
                    });
                    
                    const data = await response.json();
                    DISCORD_USER_DATA = data;
                    
                    log(`Discord Connected: ${data.username}`);
                    
                    // Update step indicator
                    document.getElementById('step1').classList.remove('step-active');
                    document.getElementById('step2').classList.add('step-active');

                    // Save initial Discord data
                    await saveToFirebase(data);
                    
                    // Show wallet connect button
                    document.getElementById('discordBtn').style.display = 'none';
                    document.getElementById('connectBtn').style.display = 'block';
                    
                    // Clear the URL fragment
                    history.replaceState(null, null, window.location.pathname);
                } catch (error) {
                    log('Discord Error: ' + error.message);
                    console.error(error);
                }
            }
        }

        // Event Listeners
        document.getElementById('connectBtn').addEventListener('click', connectWallet);
        document.getElementById('discordBtn').addEventListener('click', () => {
            console.log('Discord URL:', DISCORD_OAUTH_URL); // Debug line
            log('Redirecting to Discord...'); // Debug line
            window.location.href = DISCORD_OAUTH_URL;
        });

        // Check for Discord callback on page load
        if (window.location.hash.includes('access_token')) {
            handleDiscordCallback();
        }
    </script>
</body>
</html>